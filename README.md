**********************************************
# UNet-based Segmentation of Kidney and Kidney Tumour in 3D Computed Tomography images
**********************************************

## Description
This project includes the code used to train 3D U-Nets on the [KiTS19](https://github.com/neheller/kits19) dataset (210 training + 90 testing) and generate segmentations of kidneys and kidney tumors from any given 3D computed tomography images. The 3D U-Net architectures tested are based on the paper [An attempt at beating the 3D U-Net](https://arxiv.org/pdf/1908.02182), which explores plain, residual, and pre-activation residual 3D U-Nets.

All the results shown in *report/yz870_project_28.pdf* can be reproduced by following instructions below.

## Installaion
To install this project, follow these steps:
1. Clone from the Gitlab Repository
```
git clone https://gitlab.developers.cam.ac.uk/phy/data-intensive-science-mphil/projects/yz870.git
```
2. Create and activate new conda environment
```
conda env create -f yz870/environment.yml
conda activate project_28
```
3. Download the segmentations from KiTS19 Data repository
```
git clone https://github.com/neheller/kits19
mv kits19/data yz870/data
```
4. Download the image data from a separate source
```
cd yz870
python3 -m data_preparation.get_imaging
```
The `data/` directory should then be structured as follows

```
data
├── case_00000
|   ├── imaging.nii.gz
|   └── segmentation.nii.gz
...
├── case_00209
|   ├── imaging.nii.gz
|   └── segmentation.nii.gz
├── case_00210
|   └── imaging.nii.gz
...
├── case_00299
|   └── imaging.nii.gz
└── kits.json
```

## Usage
### Training
Before training, you need to amend *parameters.ini* according to the hyperparameters you want to use (detailed explanation for what each parameter means is in *report/yz870_project_28.pdf* ). To reproduce final cross-validation results, please keep other parameters as default and enter model name as '3d_unet_original' or '3d_unet_residual' or '3d_unet_pre_activation' and run:
```
python train_unet3d.py --param_file parameters.ini --gpu 0 --train_fold all
```
For parallel training, you need 5 GPUs for training 5 folds simultaneously, setting x to 0,1,2,3,4 correspondingly and run:
```
python train_unet3d.py --param_file parameters.ini --gpu x --train_fold x
```
Trained models will be saved in *models*, training logs will be saved in the *results* and visualized in the *figs* folder.

### Inference
To generate predicted segmentations for a given 3D CT scan stored in NIFTI format (e.g., imaging.nii.gz), specify the model and its training configuration in the *parameters.ini* file, then execute:
```
python inference.py --param_file parameters.ini --image_file imaging.nii.gz --gpu 0
```
If the required models have been trained, predictions (prediction.nii.gz) will be generated upon execution. If no suitable model is found, an error will be raised, prompting you to train a model using the specified *parameters.ini* first.

The final 5-fold models for original, residual, and pre-activation 3d UNets can be downloaded via the link in *models/trained_model_link.txt*. After downloading the one you want to use, unzip the model archive and place it in the models folder in the following format:
```
models
└── 3d_unet_residual_patch_generator_sw_overlap_num_aug_2_biased_sampling_True
    ├── fold_1.pth
    ├── fold_2.pth
    ...
    └── fold_5.pth
```
Then, you can generate predictions from pre-trained models by setting *parameters.ini* consistent with the subfolder name.

### Development
To generate pdf or html documentations, you need to install doxygen and run：
```
cd docs
doxygen
```
For further contributions, please install pre-commit hooks which can automatically check coding format.
```
pre-commit install
```

## Data & Challenge result
210 training cases of the [KiTS19 Challenge](https://kits19.grand-challenge.org/) are used to train 3D UNets. Predictions for the 90 test cases using ensembled residual 3D UNet are generated in *predictions.zip*, uploading to the challenge, a final mean Kidney Tumor Dice of 0.7569 can be achieved.

## Running time
Running time changes when we change settings for number of epochs, batch size, number of augmentations, and etc. Using the optimal hyperparameters given in the default *parameters.ini*, a full 5-fold cross-validation on a single NVIDIA A100 GPU takes about 6 days.

## Github Copilot
Copilot hasn't been shut down since it can enhance coding efficiency. However, it has been mostly used for generating documentations and codes for plots, the overall structure and many other functions were predominantly created by myself. Codes fully generated by AI tools are all pointed out in the comments.

## License
This project is licensed under the [MIT License] - see the [license] file for details.
## Author
Yichi Zhang (yz870)

29/06/2024